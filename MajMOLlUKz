-- Block client-side rejoining/teleporting for Delta
print("=== ANTI-REJOIN SCRIPT LOADED (DELTA) ===")

-- Block at the lowest level - hook __index on TeleportService
local TeleportService = game:GetService("TeleportService")

local blockedMethods = {
    "Teleport",
    "TeleportToPlaceInstance", 
    "TeleportToPrivateServer",
    "TeleportAsync",
    "TeleportPartyAsync"
}

-- Hook __index to intercept method access
local mt = getrawmetatable(game)
local oldIndex = mt.__index
local oldNamecall = mt.__namecall

setreadonly(mt, false)

mt.__index = newcclosure(function(self, key)
    if self == TeleportService then
        for _, method in ipairs(blockedMethods) do
            if key == method then
                warn("[ANTI-REJOIN] BLOCKED access to TeleportService." .. key)
                return function() 
                    warn("[ANTI-REJOIN] BLOCKED " .. key .. " call!")
                end
            end
        end
    end
    return oldIndex(self, key)
end)

mt.__namecall = newcclosure(function(self, ...)
    local method = getnamecallmethod()
    
    if self == TeleportService then
        for _, blockedMethod in ipairs(blockedMethods) do
            if method == blockedMethod then
                warn("[ANTI-REJOIN] BLOCKED " .. method .. " via __namecall!")
                return
            end
        end
    end
    
    return oldNamecall(self, ...)
end)

setreadonly(mt, true)

-- Block queue_on_teleport variants
if queue_on_teleport then
    getgenv().queue_on_teleport = function(...)
        warn("[ANTI-REJOIN] BLOCKED queue_on_teleport!")
    end
end

if queueonteleport then
    getgenv().queueonteleport = function(...)
        warn("[ANTI-REJOIN] BLOCKED queueonteleport!")
    end
end

-- Spam clear teleport queue functions
task.spawn(function()
    while task.wait() do
        -- Try both variants without erroring
        pcall(function()
            if clearteleportqueue then
                clearteleportqueue()
            end
        end)
        
        pcall(function()
            if clear_teleport_queue then
                clear_teleport_queue()
            end
        end)
    end
end)

print("[ANTI-REJOIN] Hooks installed successfully!")
print("[ANTI-REJOIN] Spamming teleport queue clear...")
print("[ANTI-REJOIN] Execute your other script now.")
print("[ANTI-REJOIN] Watch console for 'BLOCKED' messages.")
